<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Magic Mirror Project - Group 7</title>
    <link rel="stylesheet" href="style/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/addons/p5.dom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://platform.twitter.com/widgets.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-analytics.js"></script>
    <!-- Remember to include jQuery :) -->
    <!-- jQuery Modal -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css">
</head>
<body>
<div id="timeline" style="display: none"></div>

<div class="pie pie1" onclick="document.body.classList.remove('active')">
    <div class="pie-color pie-color1">
<!--        <div class="absolute">Time format</div>-->
        <svg class="card" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100">
            <image transform="translate(-20,-65)" href="images/timetext.png" width="100"
            ></image>
            <image href="images/timeFormat.png" width="100"></image>
        </svg>
    </div>
</div>
<div class="pie pie2" onclick="document.body.classList.remove('active')">
    <div class="pie-color pie-color2">
        <svg class="discount" xmlns="http://www.w3.org/2000/svg" viewBox="-375 377 100 100" width="100" height="100">
            <image transform="translate(-380,375)" href="images/region1.png" width="55"></image>
            <image transform="translate(-360,430) rotate(-40)" href="images/usflag.png" width="50"></image>
        </svg>
    </div>
</div>
<div class="pie pie3" onclick="document.body.classList.remove('active')">
    <div class="pie-color pie-color3">
        <svg class="cart" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100">
            <image transform="translate(0,6)" href="images/lang.png" width="40"></image>
            <image transform="translate(30,23)" href="images/langop.png" width="60"></image>

        </svg>
    </div>
</div>
<div class="menu" onclick="document.body.classList.toggle('active')">
    <svg class="hamburger" xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
        <g
                fill="none"
                stroke="#000"
                stroke-width="7.999"
                stroke-linecap="round"
        >
            <path d="M 55,26.000284 L 24.056276,25.999716" />
            <path d="M 24.056276,49.999716 L 75.943724,50.000284" />
            <path d="M 45,73.999716 L 75.943724,74.000284" />
            <path d="M 75.943724,26.000284 L 45,25.999716" />
            <path d="M 24.056276,73.999716 L 55,74.000284" />
        </g>
    </svg>
</div>

<iframe src="https://open.spotify.com/embed/playlist/397OIYc5tHxzQezM9okBF2" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
</body>
<script>
    /**
     * Global variables
     */
    class Profile {
        constructor(params) {
            this.name = params.name;
            this.firebaseConfig = params.firebaseConfig;
            this.weatherLoc = params.weatherLoc;
            this.clockLoc = params.clockLoc;
            this.twitterLoc = params.twitterLoc;
            this.healthStepLoc = params.healthStepLoc;
            this.healthSleepLoc = params.healthSleepLoc;
            this.welcomeLoc = params.welcomeLoc;
            this.googleEventLoc = params.googleEventLoc;
            this.apiKey = params.googleAPIkey;
            this.clientId = params.googleclientId;
            this.discoveryDocs = params.googlediscoveryDocs;
            this.scope = params.googlescope;
            this.twAccount = params.twitterSpec.account;
            this.twLimit = params.twitterSpec.limit;
            this.isReady = false;
            this.twitterData = [];
            this.healthkitStepData =[];
            this.healthkitSleepData =[];
            this.healthkitWalkingData =[];
            this.loadWeatherData = this.loadWeatherData.bind(this)
            this.loadTwitterData = this.loadTwitterData.bind(this)
            this.loadGoogleEvent = this.loadGoogleEvent.bind(this)
            this.loadHealthKitData = this.loadHealthKitData.bind(this)

        }

        init() {

            this.loadWeatherData();
            this.loadTwitterData();
            this.loadClockData();
            this.loadGoogleEvent();
            this.loadHealthKitData();
            this.loadYouTubeVideo()

        }

        showData() {
            this.displayWeather();
            this.displayTwitter();
            this.displayClock();
            this.displayGoogleEvents();
            this.displayHealthKit();
            // this.displayYouTubeVideo();
        }
        loadGoogleEvent(){
            let _this = this;
            _this.btnAuthorizationSignIn = createButton('Sign in');
            _this.btnAuthorizationSignIn.position(this.welcomeLoc.x + 120, this.welcomeLoc.y-15)

            _this.btnAuthorizationSignIn.hide()
            _this.btnAuthorizationSignOut = createButton('Sign out');

            _this.btnAuthorizationSignOut.position(this.welcomeLoc.x + 120, this.welcomeLoc.y-15)
            _this.btnAuthorizationSignOut.hide()
            jQuery.loadScript = function (url, callback) {
                jQuery.ajax({
                    url: url,
                    dataType: 'script',
                    success: callback,
                    async: true
                });
            }
            $.loadScript('https://apis.google.com/js/api.js', function(){
                gapi.load('client:auth2', function () {
                    gapi.client.init({
                        apiKey: _this.apiKey,
                        clientId: _this.clientId,
                        discoveryDocs: _this.discoveryDocs,
                        scope: _this.scope
                    }).then(function () {

                         gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                        //
                        // // Handle the initial sign-in state.
                        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                        _this.btnAuthorizationSignIn.mousePressed(handleAuthClick);
                        _this.btnAuthorizationSignOut.mousePressed(handleSignoutClick)
                    }, function(error) {
                        appendPre(JSON.stringify(error, null, 2));
                    });
                });
            });
            function listUpcomingEvents() {
                _this.eventList = [];

                gapi.client.calendar.events.list({
                    'calendarId': 'primary',
                    'timeMin': (new Date()).toISOString(),
                    'showDeleted': false,
                    'singleEvents': true,
                    'maxResults': 10,
                    'orderBy': 'startTime'
                }).then(function(response) {
                    _this.name = response.result.summary;
                    var events = response.result.items;
                    if (events.length > 0) {
                        for (let i = 0; i < events.length; i++) {
                            var event = events[i];

                            var when =  event.start.dateTime.slice(11,16)+'-'+event.end.dateTime.slice(11,16);
                            if (!when) {
                                when = event.start.date;
                            }

                            _this.eventList.push(event.summary + ' (' + when + ')')
                        }
                    }
                });
            }
            function handleSignoutClick(event) {
                gapi.auth2.getAuthInstance().signOut();
                _this.name ="Anonymous"
            }
            function updateSigninStatus(isSignedIn) {
                if(isSignedIn){
                    _this.btnAuthorizationSignOut.show();
                    _this.btnAuthorizationSignIn.hide()
                    listUpcomingEvents();
                }else{
                    _this.btnAuthorizationSignIn.show();
                    _this.btnAuthorizationSignOut.hide()
                }

            }
            function handleAuthClick(event) {
                gapi.auth2.getAuthInstance().signIn();
                _this.btnAuthorizationSignOut.show();
                _this.btnAuthorizationSignIn.hide()

            }
        }
        loadTwitterData() {
            let _this = this;
            twttr.widgets.createTimeline(
                {
                    sourceType: 'profile',
                    screenName: _this.twAccount,

                },
                document.getElementById('timeline'),
                {
                    width: '150',
                    height: '700',
                    tweetLimit: _this.twLimit,
                }).then(function (el) {
                var tweets = el.contentWindow.document.getElementsByClassName('timeline-TweetList-tweet customisable-border')
                _this.twitterData.push({
                    imgUrl: loadImage(tweets[0].getElementsByClassName('Avatar')[0].getAttribute('data-src-2x')),
                    text: "@" + _this.twAccount
                })
                for (let item of tweets) {
                    let avatar = item.getElementsByClassName('Avatar')[0].getAttribute('data-src-2x');
                    let avatarImg = loadImage(avatar);
                    let tweetText = item.getElementsByClassName('timeline-Tweet-text')[0].innerText;
                    _this.twitterData.push({imgUrl: avatarImg, text: tweetText})

                }

            });
        }
        loadHealthKitData(){
            let _this = this;
            firebase.initializeApp(this.firebaseConfig);
            firebase.analytics();

            let	parseDate = d3.time.format("%d-%b-%Y").parse;
            let rootNode = firebase.database().ref()
            let stepCount = rootNode.child("huyen-stepCounts");
            let sleep = rootNode.child("huyen-sleep");
            let walkingDistance = rootNode.child("huyen-walkingDistance");

            stepCount.once("value",function (wholeTree) {
                barchartStep(wholeTree)
            })

            sleep.once('value',function (wholeTree) {
                piechartSleep(wholeTree)
            })

            walkingDistance.once("value",function (wholeTree) {
                linechartWalking(wholeTree)
            })


        }
        loadYouTubeVideo(){
           var video = createVideo(['videos/mov_bbb.mp4'], function () {
               video.play()
               video.volume(0.8);
               video.style("z-index",100)
               video.size(200, 150);
               video.position(window.innerWidth - 250, window.innerHeight - 380)
           });

        }
        shakenWeatherBox() {
            this.weatherLoc.tempX = this.weatherLoc.x + random(-1, 1)
            this.weatherLoc.tempY = this.weatherLoc.y + random(-1, 1)
        }

        shakenTwitterBox() {
            this.twitterLoc.tempX = this.twitterLoc.x + random(-1, 1)
            this.twitterLoc.tempY = this.twitterLoc.y + random(-1, 1)
        }

        shakenHealthStepBox(){
            this.healthStepLoc.tempX = this.healthStepLoc.x + random(-1, 1)
            this.healthStepLoc.tempY = this.healthStepLoc.y + random(-1, 1)
        }
        shakenGoogleEventBox(){
            this.googleEventLoc.tempX = this.googleEventLoc.x + random(-1, 1)
            this.googleEventLoc.tempY = this.googleEventLoc.y + random(-1, 1)
        }

        shakenClockBox() {
            this.clockLoc.tempX = this.clockLoc.x + random(-1, 1)
            this.clockLoc.tempY = this.clockLoc.y + random(-1, 1)
        }

        loadWeatherData() {
            let _this = this;
            loadJSON("http://api.openweathermap.org/data/2.5/weather?zip=79415,us&APPID=110d9b8e28093bca1255c95aa342c445&units=metric", function (data) {
                _this.weatherData = data;
                _this.weatherIcon = loadImage(`http://openweathermap.org/img/wn/${_this.weatherData.weather[0].icon}@2x.png`);
                _this.isReady = true;
            });
        }

        loadClockData() {
            let dayofWeeks =
                ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            this.monthInText = [`January`, `February`, `March`, `April`, `May`, `June`, `July`, `August`, `September`, `October`, `November`, `December`]
            let _today = new Date();
            let today = _today.getDay()
            this.today = dayofWeeks[today];
        }

        displayWeather() {
            noStroke();

            // transback
            this.weatherLoc.active === true ? fill("#808080") :fill(180,120);
            rect(this.weatherLoc.tempX, this.weatherLoc.tempY-20, this.weatherLoc.w, this.weatherLoc.h, 15);

            image(this.weatherIcon, this.weatherLoc.tempX, this.weatherLoc.tempY, 50, 50);


            fill(this.weatherLoc.color);
            textSize(20);
            text(this.weatherData.main.temp + "°", this.weatherLoc.tempX + 40, this.weatherLoc.tempY+8);
            fill(255);
            textSize(14);
            textStyle(BOLD);
            fill(255, 255, 0)
            text('C', this.weatherLoc.tempX + 110, this.weatherLoc.tempY + 5);

            textStyle(NORMAL);
            fill(255);
            text(' | F', this.weatherLoc.tempX + 120, this.weatherLoc.tempY + 5);
            fill(255);
            textSize(14);
            text(`${this.weatherData.main.temp_max}° / ${this.weatherData.main.temp_min}°`, this.weatherLoc.tempX + 50, this.weatherLoc.tempY + 25);
            fill(255);
            text(`Humidity: ${this.weatherData.main.humidity}%`, this.weatherLoc.tempX + 50, this.weatherLoc.tempY + 40);


        }

        displayClock() {

            // transback
            fill(180,120)
            rect(this.clockLoc.tempX - 60, this.clockLoc.tempY - 35, 190, 70, 15);

            fill(255);
            textSize(30);
            text(`${hour()}:${minute()}`, this.clockLoc.tempX, this.clockLoc.tempY);

            fill(255);
            textSize(14);
            text(`${this.today} ${day()}, ${this.monthInText[month() - 1]}, ${year()} `, this.clockLoc.tempX - 50,
                this.clockLoc.tempY + 20);

        }
        displayGoogleEvents(){
            // transback
            fill(180,120)
            rect(this.welcomeLoc.x-70, this.welcomeLoc.y - 15, 190, 20, 5);

            textSize(14);
            fill(255);
            text(`Hello: ${this.name} `,this.welcomeLoc.x-60, this.welcomeLoc.y);

            // transback
           fill(180,120)
            rect(this.googleEventLoc.tempX-10, this.googleEventLoc.tempY - 65, 300, 160, 15);


            fill(152, 229, 152, 150);
            strokeWeight(0);
            rect(this.googleEventLoc.tempX-10, this.googleEventLoc.tempY - 15, 200, 25, 9);


            if(this.eventList !=null && this.eventList.length >0){
                textSize(14);
                fill(255);
                text(`Upcoming Events`, this.googleEventLoc.tempX, this.googleEventLoc.tempY -40);
                this.eventList.forEach((evt,i)=>{
                    if (i){
                        textSize(14);
                        fill(255);
                        // stroke(60);
                        // strokeWeight(1);
                        text(`${evt} `, this.googleEventLoc.tempX, this.googleEventLoc.tempY+i*25);
                    }
                    else {
                        textSize(14);
                        fill(0);
                        // stroke(60);
                        // strokeWeight(1);
                        text(`${evt} `, this.googleEventLoc.tempX, this.googleEventLoc.tempY+i*25);
                    }

                })
            }

        }
        displayTwitter() {
            // transback
           fill(180,120)
            rect(this.twitterLoc.tempX-5, 200, 330, this.twitterData.length* 60 + 30, 15)
            textSize(14);
            fill(255);
            if (this.twitterData.length > 0) {
                this.twitterData.forEach((tweet, index) => {
                    image(tweet.imgUrl, this.twitterLoc.tempX + 10, this.twitterLoc.tempY + index * 60, 50, 50);
                    text(tweet.text, this.twitterLoc.tempX + 70, this.twitterLoc.tempY + index * 60, this.twitterLoc.w, this.twitterLoc.h);
                })
            }
        }
        displayYouTubeVideo(){

        }
        displayHealthKit() {
            // transback
            fill(180,120)
            rect(130, 570, 1060, 200, 15);

            // if(this.healthkitStepData.length > 0){
            //     this.healthkitStepData.forEach((evt,i)=>{
            //         textSize(14);
            //         rect(this.healthStepLoc.tempX + (i*15), this.healthStepLoc.tempY - evt.value/100, 10, evt.value/100)
            //         fill(255);
            //         text("Step Counts", this.healthStepLoc.tempX, this.healthStepLoc.tempY + 20)
            //     })
            // }

        }
    }

    var WEBCAM, CANVAS, CURRENTPROFILE, counter = 0, isDraggable = false, btnMove, dragging = false, btnBrighness,
        slider, sliderVisible = false;
    const params = {

        vinhProfile: {
            firebaseConfig: {
                apiKey: "AIzaSyCeFJpmiOFaStW7l-LzKW08ADjHEJtcQ-E",
                authDomain: "healthkitfirebase.firebaseapp.com",
                databaseURL: "https://healthkitfirebase.firebaseio.com",
                projectId: "healthkitfirebase",
                storageBucket: "healthkitfirebase.appspot.com",
                messagingSenderId: "189248516188",
                appId: "1:189248516188:web:f7962b4204ec3f84b17699",
                measurementId: "G-PXCL7HQGJW"
            },
            name: "Vinh T. Nguyen",
            twitterSpec: {
                account:  "huyendoesstuff",
                limit: 4,
            },

            weatherLoc: {
                x: 190,
                y: 30,
                tempX: 190,
                tempY: 30,
                w: 150,
                h: 80,
                color: '#FFF'
            },
            clockLoc: {
                x: window.innerWidth / 2,
                y: 30,
                w: 200,
                h: 200,
                tempX: window.innerWidth / 2,
                tempY: 50,
                color: '#FFF'
            },
            twitterLoc: {
                x: 10,
                y: 220,
                w: 250,
                h: 350,
                tempX: 10,
                tempY: 220,
                color: '#FFF'
            },
            healthStepLoc: {
                x: 400,
                y: window.innerHeight - 100,
                w: 300,
                h: 100,
                tempX:400,
                tempY: window.innerHeight - 100,
            },
            healthSleepLoc: {
                x: 600,
                y: window.innerHeight - 100,
                w: 300,
                h: 100,
                tempX:600,
                tempY: window.innerHeight - 100,
            },
            welcomeLoc: {
                x: window.innerWidth - 200,
                y: 30,
                w: 150,
                h: 100,
            },
            googleEventLoc:{
                x: window.innerWidth - 300,
                y: 150,
                tempX: window.innerWidth - 300,
                tempY: 150,
                w: 200,
                h: 400,
                color: '#FFF'
            },
            googleAPIkey: "AIzaSyCtJzTr3KTtbMPC3Aa9uCOOsKnw5Zw44rg",
            googleclientId: '470126462623-4fuglh8aupd7q6i815vs60q3u6ebl7rj.apps.googleusercontent.com',
            googlediscoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
            googlescope: "https://www.googleapis.com/auth/calendar.readonly"
        },
        huyenProfile: {
            firebaseConfig: {
                apiKey: "AIzaSyCeFJpmiOFaStW7l-LzKW08ADjHEJtcQ-E",
                authDomain: "healthkitfirebase.firebaseapp.com",
                databaseURL: "https://healthkitfirebase.firebaseio.com",
                projectId: "healthkitfirebase",
                storageBucket: "healthkitfirebase.appspot.com",
                messagingSenderId: "189248516188",
                appId: "1:189248516188:web:f7962b4204ec3f84b17699",
                measurementId: "G-PXCL7HQGJW"
            },
            name: "Huyen Nguyen",
            twitterSpec: {
                account:  "huyendoesstuff",
                limit: 8,
            },
            weatherLoc: {
                x: 950,
                y: 400,
                tempX: 3 * window.innerWidth / 4,
                tempY: 40,
                w: 150,
                h: 100,
                color: '#f4a9dc'
            },
            clockLoc: {
                x: window.innerWidth / 2,
                y: 30,
                w: 200,
                h: 200,
                tempX: window.innerWidth / 4,
                tempY: 50,
                color: '#FFF'
            },
            twitterLoc: {
                x: 10,
                y: 150,
                w: 250,
                h: 350,
                tempX: window.innerWidth - 400,
                tempY: 150,
                color: '#FFF'
            },
            healthLoc: {
                x: 10,
                y: window.innerHeight - 200,
                w: 150,
                h: 50,
            },
            welcomeLoc: {
                x: window.innerWidth - 400,
                y: 30,
                w: 150,
                h: 100,
            },
            googleAPIkey: "AIzaSyCR8FuCOVFEMRdr-ain13oH_VX69qcbvaI",
            googleclientId: '470126462623-4fuglh8aupd7q6i815vs60q3u6ebl7rj.apps.googleusercontent.com',
            googlediscoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
            googlescope: "https://www.googleapis.com/auth/calendar.readonly"
        },
        linhProfile: {
            name: "Linh Ho Manh",
            twitterSpec: {
                account:  "linhhomanh",
                limit: 4,
            },
            weatherLoc: {
                x: 150,
                y: 30,
                tempX: 150,
                tempY: window.innerHeight,
                w: 150,
                h: 100,
                color: '#FFF'
            },
            clockLoc: {
                x: window.innerWidth / 2,
                y: 30,
                w: 200,
                h: 200,
                tempX: window.innerWidth / 2,
                tempY: window.innerHeight - 100,
                color: '#FFF'
            },
            twitterLoc: {
                x: 10,
                y: 150,
                w: 250,
                h: 350,
                tempX: 10,
                tempY: 550,
                color: '#FFF'
            },
            healthLoc: {
                x: 10,
                y: window.innerHeight - 100,
                w: 150,
                h: 50,
            },
            welcomeLoc: {
                x: window.innerWidth - 200,
                y: 30,
                w: 150,
                h: 100,
            },
            googleAPIkey: "AIzaSyCtJzTr3KTtbMPC3Aa9uCOOsKnw5Zw44rg",
            googleclientId: '470126462623-4fuglh8aupd7q6i815vs60q3u6ebl7rj.apps.googleusercontent.com',
            googlediscoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
            googlescope: "https://www.googleapis.com/auth/calendar.readonly"
        }
    };

    /**
     * Setup control and parameters
     */
    function preload() {
        CURRENTPROFILE = new Profile(params.vinhProfile)
        CURRENTPROFILE.init()
    }

    function setup() {
        CANVAS = createCanvas(windowWidth, windowHeight);
        CANVAS.style("z-index",-1)
        btnMove = createButton('Done');
        btnMove.position(width - 70, 50);
        btnMove.mousePressed(btnMoveMousePressed)
        btnMove.hide();
        btnBrighness = createButton('Brighness')
        btnBrighness.position(19, height - 60)
        btnBrighness.style("background-color", "#000");
        btnBrighness.style("color", "#fff");
        btnBrighness.size(100, 40)
        btnBrighness.mousePressed(btnBrighnessMousePressed)
        slider = createSlider(0, 255, 200);
        slider.position(19, height - 90);
        slider.style('width', '100px');
        slider.hide()
        WEBCAM = createCapture(VIDEO);
        WEBCAM.id('inputVideo')
        WEBCAM.loop();
        WEBCAM.hide();
        CANVAS.position(0, 0);

    }

    function draw() {
        let val = slider.value();
        tint(val); // Display at half opacity
        image(WEBCAM, 0, 0, width, height);
        if (mouseIsPressed) {
            counter++
        }
        if (counter > 120) {
            isDraggable = true;

            btnMove.show()

        }
        if (CURRENTPROFILE.isReady) {
            if (isDraggable && !dragging) {
                CURRENTPROFILE.shakenWeatherBox();
                CURRENTPROFILE.shakenTwitterBox();
                CURRENTPROFILE.shakenClockBox();
                CURRENTPROFILE.shakenGoogleEventBox();
                CURRENTPROFILE.shakenHealthStepBox();
            }
            CURRENTPROFILE.showData()
        }
    }

    /**
     * Interaction control section and parameters
     * @param event
     */
    function btnBrighnessMousePressed() {

        sliderVisible = !sliderVisible;
        sliderVisible === true ? slider.show() : slider.hide()
        let c = sliderVisible === true ? "#00f" : "#000";
        btnBrighness.style("background-color", c);
        btnBrighness.style("color", "#fff");
    }

    function mouseDragged(event) {
        cursor(MOVE);
        if (isDraggable) {
            if (CURRENTPROFILE.weatherLoc.active === true) {
                CURRENTPROFILE.weatherLoc.tempX = mouseX;
                CURRENTPROFILE.weatherLoc.tempY = mouseY;
            }

            if (CURRENTPROFILE.twitterLoc.active === true) {
                CURRENTPROFILE.twitterLoc.tempX = mouseX;
                CURRENTPROFILE.twitterLoc.tempY = mouseY;
            }

            if (CURRENTPROFILE.clockLoc.active === true) {
                CURRENTPROFILE.clockLoc.tempX = mouseX;
                CURRENTPROFILE.clockLoc.tempY = mouseY;
            }

            if (CURRENTPROFILE.googleEventLoc.active === true) {
                CURRENTPROFILE.googleEventLoc.tempX = mouseX;
                CURRENTPROFILE.googleEventLoc.tempY = mouseY;
            }

            if (CURRENTPROFILE.healthStepLoc.active === true) {
                CURRENTPROFILE.healthStepLoc.tempX = mouseX;
                CURRENTPROFILE.healthStepLoc.tempY = mouseY;
            }
            return false;
        }
    }

    function mousePressed() {
        cursor(MOVE);
        dragging = true;
        if (isDraggable) {
            // Check if weatherbox is clicked
            if (mouseX > CURRENTPROFILE.weatherLoc.tempX && mouseX < CURRENTPROFILE.weatherLoc.tempX + CURRENTPROFILE.weatherLoc.w && mouseY > CURRENTPROFILE.weatherLoc.tempY && mouseY < CURRENTPROFILE.weatherLoc.tempY + CURRENTPROFILE.weatherLoc.h) {
                CURRENTPROFILE.weatherLoc.active = true;
                CURRENTPROFILE.weatherLoc.color = '#f00'
            } else {
                CURRENTPROFILE.weatherLoc.x = CURRENTPROFILE.weatherLoc.tempX;
                CURRENTPROFILE.weatherLoc.y = CURRENTPROFILE.weatherLoc.tempY;
                CURRENTPROFILE.weatherLoc.active = false;
                CURRENTPROFILE.weatherLoc.color = 'blue'
            }

            if (mouseX > CURRENTPROFILE.twitterLoc.tempX && mouseX < CURRENTPROFILE.twitterLoc.tempX + CURRENTPROFILE.twitterLoc.w && mouseY > CURRENTPROFILE.twitterLoc.tempY && mouseY < CURRENTPROFILE.twitterLoc.tempY + CURRENTPROFILE.twitterLoc.h) {
                CURRENTPROFILE.twitterLoc.active = true;
                CURRENTPROFILE.twitterLoc.color = '#f00'
            } else {
                CURRENTPROFILE.twitterLoc.x = CURRENTPROFILE.twitterLoc.tempX;
                CURRENTPROFILE.twitterLoc.y = CURRENTPROFILE.twitterLoc.tempY;
                CURRENTPROFILE.twitterLoc.active = false;
                CURRENTPROFILE.twitterLoc.color = 'blue'
            }

            if (mouseX > CURRENTPROFILE.clockLoc.tempX && mouseX < CURRENTPROFILE.clockLoc.tempX + CURRENTPROFILE.clockLoc.w && mouseY > CURRENTPROFILE.clockLoc.tempY && mouseY < CURRENTPROFILE.clockLoc.tempY + CURRENTPROFILE.clockLoc.h) {
                CURRENTPROFILE.clockLoc.active = true;
                CURRENTPROFILE.clockLoc.color = '#f00'
            } else {
                CURRENTPROFILE.clockLoc.x = CURRENTPROFILE.clockLoc.tempX;
                CURRENTPROFILE.clockLoc.y = CURRENTPROFILE.clockLoc.tempY;
                CURRENTPROFILE.clockLoc.active = false;
                CURRENTPROFILE.clockLoc.color = 'blue'
            }

            if (mouseX > CURRENTPROFILE.googleEventLoc.tempX && mouseX < CURRENTPROFILE.googleEventLoc.tempX + CURRENTPROFILE.googleEventLoc.w && mouseY > CURRENTPROFILE.googleEventLoc.tempY && mouseY < CURRENTPROFILE.googleEventLoc.tempY + CURRENTPROFILE.googleEventLoc.h) {
                CURRENTPROFILE.googleEventLoc.active = true;
                CURRENTPROFILE.googleEventLoc.color = '#f00'
            } else {
                CURRENTPROFILE.googleEventLoc.x = CURRENTPROFILE.googleEventLoc.tempX;
                CURRENTPROFILE.googleEventLoc.y = CURRENTPROFILE.googleEventLoc.tempY;
                CURRENTPROFILE.googleEventLoc.active = false;
                CURRENTPROFILE.googleEventLoc.color = 'blue'
            }

            if (mouseX > CURRENTPROFILE.healthStepLoc.tempX && mouseX < CURRENTPROFILE.healthStepLoc.tempX + CURRENTPROFILE.healthStepLoc.w && mouseY > CURRENTPROFILE.healthStepLoc.tempY && mouseY < CURRENTPROFILE.healthStepLoc.tempY + CURRENTPROFILE.healthStepLoc.h) {
                CURRENTPROFILE.healthStepLoc.active = true;
                CURRENTPROFILE.healthStepLoc.color = '#f00'
            } else {
                CURRENTPROFILE.healthStepLoc.x = CURRENTPROFILE.healthStepLoc.tempX;
                CURRENTPROFILE.healthStepLoc.y = CURRENTPROFILE.healthStepLoc.tempY;
                CURRENTPROFILE.healthStepLoc.active = false;
                CURRENTPROFILE.healthStepLoc.color = 'blue'
            }
            return false;
        }
    }

    function mouseReleased() {
        counter = 0;
        cursor(ARROW);
        dragging = false;
        CURRENTPROFILE.weatherLoc.x = CURRENTPROFILE.weatherLoc.tempX;
        CURRENTPROFILE.weatherLoc.y = CURRENTPROFILE.weatherLoc.tempY;

        CURRENTPROFILE.twitterLoc.x = CURRENTPROFILE.twitterLoc.tempX;
        CURRENTPROFILE.twitterLoc.y = CURRENTPROFILE.twitterLoc.tempY;

        CURRENTPROFILE.clockLoc.x = CURRENTPROFILE.clockLoc.tempX;
        CURRENTPROFILE.clockLoc.y = CURRENTPROFILE.clockLoc.tempY;

        CURRENTPROFILE.googleEventLoc.x = CURRENTPROFILE.googleEventLoc.tempX;
        CURRENTPROFILE.googleEventLoc.y = CURRENTPROFILE.googleEventLoc.tempY;

        CURRENTPROFILE.healthStepLoc.x = CURRENTPROFILE.healthStepLoc.tempX;
        CURRENTPROFILE.healthStepLoc.y = CURRENTPROFILE.healthStepLoc.tempY;
    }

    function btnMoveMousePressed() {
        isDraggable = false;
        btnMove.hide()
    }

    function barchartSleep(wholeTree) {
        console.log(wholeTree)

// Parse the date / time
        let	parseDate = d3.time.format("%d-%b-%Y").parse;
        let count = 0;
        let data = [];
        wholeTree.forEach(item=>{
            data.push({date:parseDate(item.key), value:+item.val()/(60*60)});
            count += 1;
        });
        data = data.sort(function (a,b) {
            return a.date - b.date
        })

        console.log(data)

        let margin = {top: 20, right: 20, bottom: 70, left: 40},
            width = 50*count - margin.left - margin.right,
            height = 200 - margin.top - margin.bottom;

        let x = d3.scale.ordinal().rangeRoundBands([0, width], .05);

        let y = d3.scale.linear().range([height, 0]);

        let xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom")
            .tickFormat(d3.time.format("%d-%m"));

        let yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .ticks(10);

        let svg = d3.select("body").append("svg")

            .attr("id",'sleep')
            .attr("class", "sleepchart")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        x.domain(data.map(function(d) { return d.date; }));
        y.domain([0, d3.max(data, function(d) { return d.value; })]);

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
            .selectAll("text")
            .style("text-anchor", "end")
            .attr('class','text')
            .attr("dx", "-.8em")
            .attr("dy", "-.55em")
            .attr("transform", "rotate(-90)" )
        ;

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis.ticks(5))
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Sleep (hours)");

        svg.selectAll("bar")
            .data(data)
            .enter().append("rect")
            .style("fill", "steelblue")
            .style('opacity',0.3)
            .attr("x", function(d) { return x(d.date); })
            .attr("width", x.rangeBand())
            .attr("y", function(d) { return y(d.value); })
            .attr("height", function(d) { return height - y(d.value); });
    }

    function barchartStep(wholeTree) {
        console.log(wholeTree)

// Parse the date / time
        let	parseDate = d3.time.format("%d-%b-%Y").parse;
        let count = 0;
        let data = [];
        wholeTree.forEach(item=>{
            data.push({date:parseDate(item.key), value:+item.val()});
            count += 1;
        });
        data = data.sort(function (a,b) {
            return a.date - b.date
        })

        console.log(data)

        let margin = {top: 20, right: 20, bottom: 70, left: 60},
            width = 70*count - margin.left - margin.right,
            height = 200 - margin.top - margin.bottom;

        let x = d3.scale.ordinal().rangeRoundBands([0, width], .05);

        let y = d3.scale.linear().range([height, 0]);

        let xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom")
            .tickFormat(d3.time.format("%a %d"))
        ;

        let yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .ticks(10);

        let svg = d3.select("body").append("svg")
            .attr("id",'sleep')
            .attr("class", "barchart-step")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        x.domain(data.map(function(d) { return d.date; }));
        y.domain([0, d3.max(data, function(d) { return d.value; })]);

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
            .selectAll("text")
            .style("text-anchor", "middle")
            .attr('class','text')
            // .attr("dx", "-.8em")
            // .attr("dy", "-.55em")
            .attr("dy", ".6em")
            // .attr("transform", "rotate(-90)" )
        ;



        svg.selectAll("bar")
            .data(data)
            .enter().append("rect")
            .style("fill", "steelblue")
            .style('opacity',0.5)
            .attr("x", function(d) { return x(d.date); })
            .attr("width", x.rangeBand())
            .attr("y", function(d) { return y(d.value); })
            .attr("height", function(d) { return height - y(d.value); });

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis.ticks(5))
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Step count ");
    }


    function piechartSleep(wholeTree) {
        // console.log(wholeTree)

// Parse the date / time
        let	parseDate = d3.time.format("%d-%b-%Y").parse;
        var format = d3.time.format("%a %d");
        let count = 0;
        let data = [];
        wholeTree.forEach(item=>{
            data.push({
                date:format(new Date(Date.parse(parseDate(item.key)))),
                value:+item.val()/(60*60)});
            count += 1;
        });
        data = data.sort(function (a,b) {
            return a.date - b.date
        })

        var width = 250,
            height = 150,
            height2 = 170,
            radius = Math.min(width, height) / 2;

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height2)
            .attr("class", "piechart-sleep")
            .append("g")

        svg.append("g")
            .attr("class", "slices");
        svg.append("g")
            .attr("class", "labels");
        svg.append("g")
            .attr("class", "lines");



        var pie = d3.layout.pie()
            .sort(null)
            .value(function(d) {
                return d.value;
            });

        var arc = d3.svg.arc()
            .outerRadius(radius * 0.8)
            .innerRadius(radius * 0.4);

        var outerArc = d3.svg.arc()
            .innerRadius(radius * 0.9)
            .outerRadius(radius * 0.9);

        svg.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        var key = function(d){ return d.data.date; };

        var color = d3.scale.ordinal()
            .domain(data.map(d => d.date))
            .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56"]);

        function randomData (){
            var labels = color.domain();
            console.log(labels)
            return labels.map(function(label){
                return { date: label, value: Math.random() }
            });
        }
        change(data);

        function change(data) {

            /* ------- PIE SLICES -------*/
            var slice = svg.select(".slices").selectAll("path.slice")
                .data(pie(data), key);

            slice.enter()
                .insert("path")
                .style("fill", function(d) { return color(d.data.date); })
                .style("opacity", 0.8)
                .attr("class", "slice");

            slice
                .transition().duration(1000)
                .attrTween("d", function(d) {
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function(t) {
                        return arc(interpolate(t));
                    };
                })

            slice.exit()
                .remove();

            /* ------- TEXT LABELS -------*/

            var text = svg.select(".labels").selectAll("text")
                .data(pie(data), key);

            text.enter()
                .append("text")
                .attr("dy", ".35em")
                .text(function(d) {
                    return d.data.date;
                });

            function midAngle(d){
                return d.startAngle + (d.endAngle - d.startAngle)/2;
            }

            text.transition().duration(1000)
                .attrTween("transform", function(d) {
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function(t) {
                        var d2 = interpolate(t);
                        var pos = outerArc.centroid(d2);
                        pos[0] = radius * (midAngle(d2) < Math.PI ? 1 : -1);
                        return "translate("+ pos +")";
                    };
                })
                .styleTween("text-anchor", function(d){
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function(t) {
                        var d2 = interpolate(t);
                        return midAngle(d2) < Math.PI ? "start":"end";
                    };
                });

            text.exit()
                .remove();

            /* ------- SLICE TO TEXT POLYLINES -------*/

            var polyline = svg.select(".lines").selectAll("polyline")
                .data(pie(data), key);

            polyline.enter()
                .append("polyline");

            polyline.transition().duration(1000)
                .attrTween("points", function(d){
                    this._current = this._current || d;
                    var interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(0);
                    return function(t) {
                        var d2 = interpolate(t);
                        var pos = outerArc.centroid(d2);
                        pos[0] = radius * 0.95 * (midAngle(d2) < Math.PI ? 1 : -1);
                        return [arc.centroid(d2), outerArc.centroid(d2), pos];
                    };
                });

            polyline.exit()
                .remove();

            svg.append("text")
                .attr("transform", "translate(-40,90)")
                .text("Sleep (hours)")
        };

    }

    function linechartWalking(wholeTree) {
        console.log(wholeTree)
// Parse the date / time

        let count = 0;
        var parseDate = d3.time.format("%d-%b-%Y").parse;
        let data = [];
        wholeTree.forEach(item=>{
            data.push({
                date:parseDate(item.key),
                value:+item.val()});

            count += 1;
        });
        data = data.sort(function (a,b) {
            return a.date - b.date
        })

        console.log(data)

        var margin = {top: 30, right: 20, bottom: 30, left: 50},
            width = 300 - margin.left - margin.right,
            height = 170 - margin.top - margin.bottom;


// Set the ranges
        var x = d3.time.scale().range([0, width]);
        var y = d3.scale.linear().range([height, 0]);

// Define the axes
        var xAxis = d3.svg.axis().scale(x)
            .orient("bottom").ticks(count);

        var yAxis = d3.svg.axis().scale(y)
            .orient("left").ticks(5);

// Define the line
        var valueline = d3.svg.line()
            .x(function(d) { return x(d.date); })
            .y(function(d) { return y(d.value); });

// Adds the svg canvas
        var svg = d3.select("body")
            .append("svg")
            .attr("class", "linechart")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // Scale the range of the data
        x.domain(d3.extent(data, function(d) { return d.date; }));
        y.domain([0, d3.max(data, function(d) { return d.value; })]);

        // Add the valueline path.
        svg.append("path")
            .attr("class", "path-chart")
            .attr("d", valueline(data));

        // Add the X Axis
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        // Add the Y Axis
        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Walking (miles)");;


    }
</script>
</html>